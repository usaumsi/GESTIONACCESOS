<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Cuentas de Usuario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- PapaParse: Correct name, deferred, and loaded before the app module -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-content { max-height: 90vh; }
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #maestraItemsContainer li:hover .delete-item-btn { opacity: 1; }
        button:disabled { cursor: not-allowed; opacity: 0.5; }
    </style>
</head>
<body>

    <!-- Pantalla de Login -->
    <div id="loginContainer" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">Bienvenido</h1>
                <p class="mt-2 text-gray-600">Inicia sesión para acceder al sistema</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input id="email" name="email" type="email" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="usuario@minedu.gob.pe">
                </div>
                <div>
                    <label for="password" class="text-sm font-medium text-gray-700">Contraseña</label>
                    <input id="password" name="password" type="password" required class="w-full px-3 py-2 mt-1 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Tu contraseña">
                </div>
                <div>
                    <button type="submit" class="w-full py-2 px-4 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Ingresar
                    </button>
                </div>
                <p id="loginError" class="text-sm text-center text-red-600"></p>
            </form>
        </div>
    </div>

    <!-- Contenedor Principal de la App (oculto por defecto) -->
    <div id="appContainer" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="mb-8 relative">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-800">Sistema de Gestión de Cuentas</h1>
                    <p class="text-gray-600 mt-2">Administra los registros de cuentas de usuario de forma centralizada.</p>
                </div>
                <div id="userInfo" class="absolute top-0 right-0 text-right">
                    <p class="text-sm text-gray-700 font-semibold" id="userEmail"></p>
                    <p class="text-xs text-gray-500" id="userRole"></p>
                    <button id="changePasswordBtn" class="mt-1 text-xs text-blue-600 hover:underline">Cambiar Contraseña</button>
                    <button id="logoutBtn" class="mt-1 text-xs text-red-600 hover:underline ml-2">Cerrar Sesión</button>
                </div>
            </header>

            <!-- Controles y Búsqueda -->
            <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="relative w-full sm:w-auto sm:flex-grow">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" placeholder="Buscar por nombre, ticket, estado..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex flex-wrap justify-end gap-2">
                    <button id="auditLogBtn" class="bg-yellow-500 text-white font-medium py-2 px-3 rounded-lg hover:bg-yellow-600 flex items-center justify-center gap-2 text-sm"><i class="fas fa-history"></i><span>Auditoría</span></button>
                    <button id="manageUsersBtn" class="bg-purple-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2 text-sm"><i class="fas fa-users-cog"></i><span>Usuarios</span></button>
                    <button id="gestionMaestrasBtn" class="bg-gray-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2 text-sm"><i class="fas fa-database"></i><span>Maestras</span></button>
                    <button id="loadCsvBtn" class="bg-green-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-green-700 flex items-center justify-center gap-2 text-sm"><i class="fas fa-file-upload"></i><span>Cargar</span></button>
                    <button id="exportCsvBtn" class="bg-teal-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2 text-sm" disabled><i class="fas fa-file-download"></i><span>Exportar</span></button>
                    <button id="addAccountBtn" class="bg-blue-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2 text-sm"><i class="fas fa-plus"></i><span>Agregar</span></button>
                </div>
                <input type="file" id="csvInput" class="hidden" accept=".csv,text/csv">
            </div>

            <!-- Tabla de Cuentas -->
            <div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-100"><tr><th class="p-4 text-center"><input type="checkbox" id="selectAllCheckbox" class="h-5 w-5 rounded"></th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Nombre Muestra</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Nombre</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Apellido</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">UserPrin</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">SAM</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">SAM_PROPUESTO</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">OFI</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">PASS</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">DESC</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Fono</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Titulo</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Departamento</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Compania</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Proxy</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">SINAD -TICKET</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">FECHA</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">Creador</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">ESTADO</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">CAS RESPONSABLE</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">TIPO</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">DEBAJA 90 DIAS</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">LICENCIA</th><th class="p-4 font-semibold text-gray-700 whitespace-nowrap">OBSERVACION</th><th class="p-4 font-semibold text-gray-700 text-center whitespace-nowrap">Acciones</th></tr></thead><tbody id="accountsTableBody"></tbody></table></div>
        </div>
    </div>


    <!-- Modals -->
    <div id="accountModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-5xl modal transform scale-95 opacity-0 modal-content overflow-y-auto"><div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10"><h2 id="modalTitle" class="text-2xl font-bold text-gray-800"></h2><button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="accountForm" class="p-6"><input type="hidden" id="accountId"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"><div><label for="nombreMuestra" class="block text-sm font-medium text-gray-700 mb-1">Nombre Muestra</label><input type="text" id="nombreMuestra" class="w-full p-2 border rounded-lg bg-gray-100" required readonly></div><div><label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label><input type="text" id="nombre" class="w-full p-2 border rounded-lg"></div><div><label for="apellido" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label><input type="text" id="apellido" class="w-full p-2 border rounded-lg"></div><div><label for="userPrin" class="block text-sm font-medium text-gray-700 mb-1">UserPrincipal</label><input type="email" id="userPrin" class="w-full p-2 border rounded-lg bg-gray-100" required readonly></div><div><label for="sam" class="block text-sm font-medium text-gray-700 mb-1">SAM</label><input type="text" id="sam" class="w-full p-2 border rounded-lg" maxlength="20"></div><div><label for="samPropuesto" class="block text-sm font-medium text-gray-700 mb-1">SAM Propuesto (Sugerencias)</label><textarea id="samPropuesto" class="w-full p-2 border rounded-lg" rows="2"></textarea></div><div><label for="ofi" class="block text-sm font-medium text-gray-700 mb-1">Oficina</label><select id="ofi" class="w-full p-2 border rounded-lg bg-white"></select></div><div><label for="pass" class="block text-sm font-medium text-gray-700 mb-1">PASS</label><select id="pass" class="w-full p-2 border rounded-lg bg-white"></select></div><div><label for="desc" class="block text-sm font-medium text-gray-700 mb-1">Descripción/DNI</label><input type="text" id="desc" class="w-full p-2 border rounded-lg"></div><div><label for="fono" class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label><input type="text" id="fono" class="w-full p-2 border rounded-lg"></div><div><label for="titulo" class="block text-sm font-medium text-gray-700 mb-1">Título/Cargo</label><select id="titulo" class="w-full p-2 border rounded-lg bg-white"></select></div><div><label for="departamento" class="block text-sm font-medium text-gray-700 mb-1">Departamento</label><input type="text" id="departamento" class="w-full p-2 border rounded-lg bg-gray-100" readonly></div><div><label for="compania" class="block text-sm font-medium text-gray-700 mb-1">Compañía/Sede</label><select id="compania" class="w-full p-2 border rounded-lg bg-white"></select></div><div><label for="proxy" class="block text-sm font-medium text-gray-700 mb-1">Proxy</label><input type="text" id="proxy" class="w-full p-2 border rounded-lg bg-gray-100" readonly></div><div><label for="ticket" class="block text-sm font-medium text-gray-700 mb-1">SINAD - TICKET</label><input type="text" id="ticket" class="w-full p-2 border rounded-lg"></div><div><label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label><input type="date" id="fecha" class="w-full p-2 border rounded-lg"></div><div><label for="creador" class="block text-sm font-medium text-gray-700 mb-1">Creador / Última Modificación</label><input type="text" id="creador" class="w-full p-2 border rounded-lg bg-gray-100" readonly></div><div><label for="estado" class="block text-sm font-medium text-gray-700 mb-1">Estado</label><select id="estado" class="w-full p-2 border rounded-lg bg-white"></select></div><div><label for="casResponsable" class="block text-sm font-medium text-gray-700 mb-1">CAS Responsable</label><input type="text" id="casResponsable" class="w-full p-2 border rounded-lg"></div><div><label for="tipo" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label><select id="tipo" class="w-full p-2 border rounded-lg bg-white"></select></div><div><label for="debaja90dias" class="block text-sm font-medium text-gray-700 mb-1">DEBAJA 90 DIAS</label><input type="text" id="debaja90dias" class="w-full p-2 border rounded-lg"></div><div><label for="licencia" class="block text-sm font-medium text-gray-700 mb-1">LICENCIA</label><input type="text" id="licencia" class="w-full p-2 border rounded-lg"></div><div class="lg:col-span-2"><label for="observacion" class="block text-sm font-medium text-gray-700 mb-1">Observación</label><textarea id="observacion" class="w-full p-2 border rounded-lg" rows="2"></textarea></div></div><div class="mt-8 pt-4 border-t flex justify-end gap-4"><button type="button" id="cancelBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Guardar</button></div></form></div></div>
    <div id="maestrasModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-2xl modal transform scale-95 opacity-0"><div class="px-6 py-4 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Gestionar Listas Maestras</h2><button id="closeMaestrasModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><div class="p-6"><div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"><div class="w-full sm:w-auto sm:flex-grow"><label for="maestraSelect" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar lista para editar:</label><select id="maestraSelect" class="w-full p-2 border rounded-lg bg-white"></select></div><button id="addNewMaestraBtn" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 whitespace-nowrap"><i class="fas fa-plus"></i> Nueva Lista</button></div><div class="bg-gray-50 rounded-lg p-4 border h-64 overflow-y-auto mb-4"><ul id="maestraItemsContainer" class="space-y-2"></ul></div><form id="newItemForm" class="flex gap-2"><input type="text" id="newItemInput" placeholder="Añadir nuevo valor" class="flex-grow p-2 border rounded-lg" required><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-plus"></i> Añadir</button></form></div></div></div>
    <div id="newMaestraModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal transform scale-95 opacity-0"><div class="px-6 py-4 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Crear Nueva Lista Maestra</h2><button id="closeNewMaestraModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="newMaestraForm" class="p-6"><div class="mb-4"><label for="newMaestraName" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Lista</label><input type="text" id="newMaestraName" placeholder="Ej: Proyectos" class="w-full p-2 border rounded-lg" required><p class="text-xs text-gray-500 mt-1">El nombre que se mostrará en el selector.</p></div><div class="mb-6"><label for="newMaestraId" class="block text-sm font-medium text-gray-700 mb-1">ID Único de la Lista</label><input type="text" id="newMaestraId" placeholder="Ej: proyectos" class="w-full p-2 border rounded-lg" required><p class="text-xs text-gray-500 mt-1">Un identificador corto, en minúsculas y sin espacios. No se podrá cambiar.</p></div><div class="flex justify-end gap-4"><button type="button" id="cancelNewMaestraBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Crear Lista</button></div></form></div></div>
    <div id="deleteModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-sm modal transform scale-95 opacity-0"><div class="p-6 text-center"><i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i><h3 class="text-xl font-bold text-gray-800 mb-2">¿Estás seguro?</h3><p id="deleteModalText" class="text-gray-600 mb-6"></p><div class="flex justify-center gap-4"><button id="cancelDeleteBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button><button id="confirmDeleteBtn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Eliminar</button></div></div></div></div>
    <div id="uploadModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal transform scale-95 opacity-0"><div id="uploadModalContent" class="p-6 text-center"></div></div></div>
    <div id="changePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden"><div class="bg-white rounded-lg shadow-xl w-full max-w-md modal transform scale-95 opacity-0"><div class="px-6 py-4 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Cambiar Contraseña</h2><button id="closeChangePasswordModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div><form id="changePasswordForm" class="p-6 space-y-4"><div><label for="newPassword" class="block text-sm font-medium text-gray-700">Nueva Contraseña</label><input type="password" id="newPassword" class="w-full p-2 mt-1 border rounded-lg" required></div><div><label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirmar Nueva Contraseña</label><input type="password" id="confirmPassword" class="w-full p-2 mt-1 border rounded-lg" required></div><p id="passwordChangeStatus" class="text-sm text-center"></p><div class="flex justify-end gap-4 pt-4"><button type="button" id="cancelChangePasswordBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Guardar</button></div></form></div></div>
    
    <!-- Modal para Gestionar Usuarios (Admin) -->
    <div id="userManagementModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-5xl modal transform scale-95 opacity-0">
            <div class="px-6 py-4 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Gestionar Usuarios y Roles</h2><button id="closeUserManagementModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div class="p-6">
                <div class="bg-gray-50 rounded-lg p-4 border mb-6">
                    <h3 class="font-semibold mb-2 text-gray-700">Agregar Usuario al Sistema</h3>
                    <p class="text-sm text-gray-600 mb-4">Asegúrate de haber creado primero el usuario en Firebase Authentication y copia su UID.</p>
                    <form id="addUserToSystemForm" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="lg:col-span-2">
                            <label for="newUserEmail" class="block text-sm font-medium text-gray-700">Correo del Usuario</label>
                            <input type="email" id="newUserEmail" placeholder="correo@ejemplo.com" class="w-full p-2 border rounded-lg mt-1" required>
                        </div>
                         <div>
                            <label for="newUserId" class="block text-sm font-medium text-gray-700">UID del Usuario</label>
                            <input type="text" id="newUserId" placeholder="UID de Firebase Auth" class="w-full p-2 border rounded-lg mt-1" required>
                        </div>
                        <div>
                            <label for="newUserRole" class="block text-sm font-medium text-gray-700">Rol Asignado</label>
                            <select id="newUserRole" class="w-full p-2 border rounded-lg bg-white mt-1"><option value="administrador">Administrador</option><option value="coordinador">Coordinador</option><option value="especialista">Especialista</option><option value="visitante" selected>Visitante</option></select>
                        </div>
                        <div class="lg:col-span-4 text-right">
                           <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-plus"></i> Agregar Usuario</button>
                        </div>
                    </form>
                </div>
                 <h3 class="font-semibold mb-2 text-gray-700">Usuarios del Sistema</h3>
                <div class="bg-gray-50 rounded-lg p-4 border h-[60vh] overflow-y-auto"><ul id="userListContainer" class="space-y-3"></ul></div>
            </div>
        </div>
    </div>

     <!-- Modal de Auditoría -->
    <div id="auditLogModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl h-5/6 modal transform scale-95 opacity-0 flex flex-col">
            <div class="px-6 py-4 border-b flex justify-between items-center"><h2 class="text-2xl font-bold text-gray-800">Registro de Auditoría</h2><button id="closeAuditLogModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button></div>
            <div class="p-6 flex-grow overflow-y-auto">
                <input type="text" id="auditSearchInput" placeholder="Buscar en auditoría..." class="w-full mb-4 p-2 border rounded-lg">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 sticky top-0"><tr><th class="p-3">Fecha y Hora</th><th class="p-3">Usuario</th><th class="p-3">Acción</th><th class="p-3">Cuenta Afectada</th><th class="p-3">SAM</th><th class="p-3">DNI</th><th class="p-3">Detalles</th></tr></thead>
                        <tbody id="auditLogTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, setDoc, deleteDoc, onSnapshot, query, where, writeBatch, getDocs, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        if (!window.Papa || typeof window.Papa.parse !== 'function') {
            console.error('PapaParse no cargó (revisa URL y orden de scripts)');
        }

        const firebaseConfig = { apiKey: "AIzaSyAsx90GiutoCiV9SiUsXUcfCEVSOw9aiV0", authDomain: "gestioncuentas-8f94c.firebaseapp.com", projectId: "gestioncuentas-8f94c", storageBucket: "gestioncuentas-8f94c.appspot.com", messagingSenderId: "264635413907", appId: "1:264635413907:web:f3778c3ab15700d6292466" };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let accountsCollectionRef, maestrasCollectionRef, usersCollectionRef, auditCollectionRef;
        let unsubscribeAccounts, unsubscribeMaestras, unsubscribeUsers, unsubscribeAudit;
        let allAccounts = [], allMaestras = {}, allUsers = [], allAuditLogs = [];
        let currentUserRole = null;
        
        const oficinaDependenciaMap = { 'UCG': 'OCI', 'UCF': 'OCI', 'DIPROGE': 'SENAJU', 'DINDES': 'SENAJU', 'DAIM': 'SENAJU', 'OL': 'OGA', 'OCCP': 'OGA', 'OT': 'OGA', 'OEC': 'OGA', 'OGEPER': 'OGRH', 'OGDC': 'OGRH', 'OBIR': 'OGRH', 'OCOM': 'OGC', 'ORI': 'OGC', 'OPRE': 'OGC', 'UFD': 'OPEP', 'UPP': 'OPEP', 'UPI': 'OPEP', 'UNOME': 'OPEP', 'UE': 'OSEE', 'USE': 'OSEE', 'UCSI': 'OTIC', 'USI': 'OTIC', 'UIT': 'OTIC', 'USAU': 'OTIC', 'DEI': 'DIGEBR', 'DEP': 'DIGEBR', 'DES': 'DIGEBR', 'DEFID': 'DIGEBR', 'DEBA': 'DIGEIBIRA', 'DEIB': 'DIGEIBIRA', 'DISER': 'DIGEIBIRA', 'DEBE': 'DIGESE', 'DEBEDSAR': 'DIGESE', 'DITEN': 'DIGEDD', 'DIED': 'DIGEDD', 'DIBRED': 'DIGEDD', 'DIFOID': 'DIGEDD', 'DIFODS': 'DIGEDD', 'DIPODA': 'DIGESU', 'DICOPRO': 'DIGESU', 'DISERTPA': 'DIGESUTPA', 'DIGEST': 'DIGESUTPA', 'DIRI': 'DIGEGED', 'DAGED': 'DIGEGED', 'DIFOCA': 'DIGEGED', 'DIGE': 'DIGC', 'DIF': 'DIGC', 'DIPLAN': 'DIGEIE', 'DINOR': 'DIGEIE', 'DISAFIL': 'DIGEIE', 'OCI': 'DM', 'PP': 'DM', 'CNE': 'DM', 'SENAJU': 'DM', 'FONDEP': 'DM', 'OGA': 'SG', 'OGRH': 'SG', 'OGC': 'SG', 'OTEPA': 'SG', 'OACIGED': 'SG', 'ODI': 'SG', 'OGAJ': 'SG', 'OGECI': 'SG', 'ODENAGED': 'SG', 'OPEP': 'SPE', 'OSEE': 'SPE', 'UMC': 'SPE', 'OTIC': 'SPE', 'DIGROGE': 'SNJ', 'DINDES': 'SNJ', 'DAIM': 'SNJ', 'DIGEBR': 'VMGP', 'DIGEIBIRA': 'VMGP', 'DIGESE': 'VMGP', 'DITE': 'VMGP', 'DIGEDD': 'VMGP', 'DIGESU': 'VMGP', 'DIGESUTPA': 'VMGP', 'CASLIT': 'VMGP', 'DIGERE': 'VMGP', 'DIGEGED': 'VMGI', 'DIGC': 'VMGI', 'DIGEBEC': 'VMGI', 'DIGEIE': 'VMGI', 'DM': 'DM', 'SG': 'SG', 'SPE': 'SPE', 'SNJ': 'SNJ', 'VMGP': 'VMGP', 'VMGI': 'VMGI', 'BAJA OGRH': 'BAJA OGRH', 'OGCI': 'SG', 'BAJA': 'BAJA' };

        const loginContainer = document.getElementById('loginContainer'), appContainer = document.getElementById('appContainer'), loginForm = document.getElementById('loginForm'), loginError = document.getElementById('loginError'), logoutBtn = document.getElementById('logoutBtn'), userEmailDisplay = document.getElementById('userEmail'), userRoleDisplay = document.getElementById('userRole');
        const searchInput = document.getElementById('searchInput'), accountsTableBody = document.getElementById('accountsTableBody'), addAccountBtn = document.getElementById('addAccountBtn'), closeModalBtn = document.getElementById('closeModalBtn'), cancelBtn = document.getElementById('cancelBtn'), accountModal = document.getElementById('accountModal'), accountForm = document.getElementById('accountForm'), modalTitle = document.getElementById('modalTitle'), samInput = document.getElementById('sam'), userPrinInput = document.getElementById('userPrin'), proxyInput = document.getElementById('proxy'), nombreInput = document.getElementById('nombre'), apellidoInput = document.getElementById('apellido'), nombreMuestraInput = document.getElementById('nombreMuestra'), samPropuestoInput = document.getElementById('samPropuesto'), tipoSelect = document.getElementById('tipo'), ofiSelect = document.getElementById('ofi'), departamentoInput = document.getElementById('departamento');
        const loadCsvBtn = document.getElementById('loadCsvBtn'), csvInput = document.getElementById('csvInput'), uploadModal = document.getElementById('uploadModal'), uploadModalContent = document.getElementById('uploadModalContent'), exportCsvBtn = document.getElementById('exportCsvBtn');
        const gestionMaestrasBtn = document.getElementById('gestionMaestrasBtn'), maestrasModal = document.getElementById('maestrasModal'), closeMaestrasModalBtn = document.getElementById('closeMaestrasModalBtn'), maestraSelect = document.getElementById('maestraSelect'), maestraItemsContainer = document.getElementById('maestraItemsContainer'), newItemForm = document.getElementById('newItemForm'), newItemInput = document.getElementById('newItemInput'), addNewMaestraBtn = document.getElementById('addNewMaestraBtn'), newMaestraModal = document.getElementById('newMaestraModal'), closeNewMaestraModalBtn = document.getElementById('closeNewMaestraModalBtn'), cancelNewMaestraBtn = document.getElementById('cancelNewMaestraBtn'), newMaestraForm = document.getElementById('newMaestraForm');
        const manageUsersBtn = document.getElementById('manageUsersBtn'), userManagementModal = document.getElementById('userManagementModal'), closeUserManagementModalBtn = document.getElementById('closeUserManagementModalBtn'), addUserToSystemForm = document.getElementById('addUserToSystemForm'), userListContainer = document.getElementById('userListContainer');
        const changePasswordBtn = document.getElementById('changePasswordBtn'), changePasswordModal = document.getElementById('changePasswordModal'), closeChangePasswordModalBtn = document.getElementById('closeChangePasswordModalBtn'), cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn'), changePasswordForm = document.getElementById('changePasswordForm'), passwordChangeStatus = document.getElementById('passwordChangeStatus');
        const auditLogBtn = document.getElementById('auditLogBtn'), auditLogModal = document.getElementById('auditLogModal'), closeAuditLogModalBtn = document.getElementById('closeAuditLogModalBtn'), auditLogTableBody = document.getElementById('auditLogTableBody'), auditSearchInput = document.getElementById('auditSearchInput');
        const deleteModal = document.getElementById('deleteModal'), cancelDeleteBtn = document.getElementById('cancelDeleteBtn'), confirmDeleteBtn = document.getElementById('confirmDeleteBtn'), deleteModalText = document.getElementById('deleteModalText');
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (user.email === "mcueva@minedu.gob.pe") {
                    currentUserRole = 'administrador'; 
                    if (!userDocSnap.exists()) {
                        await setDoc(userDocRef, { email: user.email, role: 'administrador' });
                    }
                } else if (userDocSnap.exists()) {
                    currentUserRole = userDocSnap.data().role;
                } else {
                    currentUserRole = 'visitante';
                }
                
                userEmailDisplay.textContent = user.email;
                userRoleDisplay.textContent = `Rol: ${currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1)}`;
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                startApp();
            } else {
                currentUserRole = null;
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                if (unsubscribeUsers) unsubscribeUsers();
                if (unsubscribeAccounts) unsubscribeAccounts();
                if (unsubscribeMaestras) unsubscribeMaestras();
                if (unsubscribeAudit) unsubscribeAudit();
            }
        });

        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            loginError.textContent = '';
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error.code, error.message);
                const map = {
                    'auth/invalid-credential': 'Usuario o contraseña incorrectos.',
                    'auth/user-not-found': 'El usuario no existe.',
                    'auth/wrong-password': 'Contraseña incorrecta.',
                    'auth/too-many-requests': 'Demasiados intentos. Intenta más tarde.',
                    'auth/network-request-failed': 'Problema de red. Revisa tu conexión.'
                };
                loginError.textContent = map[error.code] || 'Error al iniciar sesión.';
            }
        });

        logoutBtn.addEventListener('click', async () => { try { await signOut(auth); } catch (error) { console.error("Logout failed:", error); } });

        function startApp() {
            accountsCollectionRef = collection(db, `cuentas`);
            maestrasCollectionRef = collection(db, `maestras`);
            usersCollectionRef = collection(db, 'users');
            auditCollectionRef = collection(db, 'audit');
            seedInitialMaestras();
            listenForMaestras();
            listenForAccounts();
            if (currentUserRole === 'administrador') {
                listenForUsers();
                listenForAuditLog(); 
            }
            applyRolePermissions();
        }
        
        function applyRolePermissions() {
            const isAdmin = currentUserRole === 'administrador', isCoordinador = currentUserRole === 'coordinador', isEspecialista = currentUserRole === 'especialista';
            auditLogBtn.style.display = isAdmin ? 'flex' : 'none';
            manageUsersBtn.style.display = isAdmin ? 'flex' : 'none';
            gestionMaestrasBtn.style.display = isAdmin ? 'flex' : 'none';
            loadCsvBtn.style.display = isAdmin || isCoordinador ? 'flex' : 'none';
            addAccountBtn.style.display = isAdmin || isEspecialista || isCoordinador ? 'flex' : 'none';
            renderAccounts();
        }

        samInput.addEventListener('input', () => { const samValue = samInput.value.trim(); userPrinInput.value = samValue ? `${samValue}@MINEDU.GOB.PE` : ''; proxyInput.value = samValue ? `${samValue}@MINEDUPERU.MAIL.ONMICROSOFT.COM` : ''; });
        const updateNombreMuestra = () => { nombreMuestraInput.value = `${nombreInput.value.trim()} ${apellidoInput.value.trim()}`.trim(); };
        function generateSamProposals(nombre, apellido) { const nombres = nombre.trim().split(' ').filter(n => n), apellidos = apellido.trim().split(' ').filter(a => a); if (nombres.length === 0 || apellidos.length === 0) return ''; const propuestas = new Set(), pNombre1 = nombres[0] || '', pNombre2 = nombres[1] || '', pApellido1 = apellidos[0] || '', pApellido2 = apellidos[1] || ''; if (pNombre1 && pApellido1) propuestas.add(`${pNombre1.charAt(0)}${pApellido1}`.toUpperCase()); if (pNombre1 && pApellido1 && pApellido2) propuestas.add(`${pNombre1.charAt(0)}${pApellido1}${pApellido2.charAt(0)}`.toUpperCase()); if (pNombre2 && pApellido1 && pApellido2) propuestas.add(`${pNombre2.charAt(0)}${pApellido1}${pApellido2.charAt(0)}`.toUpperCase()); if (pNombre1 && pNombre2 && pApellido1 && pApellido2) propuestas.add(`${pNombre1.charAt(0)}${pNombre2.charAt(0)}${pApellido1}${pApellido2.charAt(0)}`.toUpperCase()); return Array.from(propuestas).join(', '); }
        const updateSamProposals = () => { if (tipoSelect.value && tipoSelect.value !== 'GENERICA') { samPropuestoInput.value = generateSamProposals(nombreInput.value, apellidoInput.value); } else { samPropuestoInput.value = ''; } };
        const updateDepartamento = () => { departamentoInput.value = oficinaDependenciaMap[ofiSelect.value] || ''; };
        nombreInput.addEventListener('input', updateNombreMuestra); apellidoInput.addEventListener('input', updateNombreMuestra); nombreInput.addEventListener('input', updateSamProposals); apellidoInput.addEventListener('input', updateSamProposals); tipoSelect.addEventListener('change', updateSamProposals); ofiSelect.addEventListener('change', updateDepartamento);

        const openModal = (modalEl) => { const modalContent = modalEl.querySelector('.modal'); modalEl.classList.remove('hidden'); setTimeout(() => { modalContent.classList.remove('scale-95', 'opacity-0'); }, 10); };
        const closeModal = (modalEl) => { const modalContent = modalEl.querySelector('.modal'); modalContent.classList.add('scale-95', 'opacity-0'); setTimeout(() => { modalEl.classList.add('hidden'); }, 300); };
        
        const initialMaestras = { ofi: { name: 'Oficinas', items: ["CASLIT", "CNE", "DM", "DAGED", "DICOPRO", "DEBA", "DEBE", "DEBEDSAR", "DEFID", "DEI", "DEIB", "DEP", "DES", "DIED", "DIFODS", "DIFOID", "DIFOCA", "DIF", "DIGEST", "DIGERE", "DIGE", "DITE", "DINOR", "DIPLAN", "DIPODA", "DIBRED", "DIRI", "DISAFIL", "DISERTPA", "DISER", "DIGC", "DIGEDD", "DIGEIBIRA", "DIGEBR", "DIGESU", "DIGESUTPA", "DIGEGED", "DIGEIE", "DIGESE", "DITEN", "OACIGED", "OBIR", "OCOM", "OCCP", "ODENAGED", "ODI", "OEC", "OGEPER", "OGDC", "OL", "UMC", "OPEP", "OPRE", "ORI", "OSEE", "OTIC", "OT", "OGA", "OGAJ", "OGC", "OGCI", "OGRH", "OTEPA", "OCI", "PP", "SPE", "SG", "SENAJU", "UCSI", "UE", "UFD", "UIT", "UNOME", "UPP", "UPI", "USE", "USAU", "USI", "VMGI", "VMGP", "OTROS", "BAJA", "FONDEP"] }, pass: { name: 'Contraseñas', items: ["cDu*M1042", "cDu*M1043", "cDu*M1044", "cDu*M1045", "cDu*M1046", "cDu*M1047", "cDu*M1048", "cDu*M1049", "cDu*M1050", "NO APLICA", '2#oY66^$;{6t7-6o.yB18kWs;2&2#y6t7X6o.yB1!85S2HyJIK8Ao%8"5B<8x_0qA38EoktXB5t6o4y(8kWsX2&2#y'] }, titulo: { name: 'Títulos/Cargos', items: ["ABOGADA", "ABOGADO", "ACOMPAÑANTE PEDAGOGICO", "ADMINISTRADOR/A", "ADMINISTRATIVO", "ANALISTA", "APOYO ADMINISTRATIVO", "APOYO OPERATIVO", "ARCHIVERO", "ARQUITECTO", "ASESOR", "ASESOR LEGAL", "ASESOR/A", "ASISTENTE", "ASISTente ADMINISTRATIVO", "ASISTENTE DE DIRECCION", "ASISTENTE TECNICO", "AUDITOR", "AUXILIAR", "BIBLIOTECOLOGO", "CHOFER", "CIRUJANO DENTISTA", "CONDUCTOR DE VEHICULOS", "CONTADOR", "COORDINADOR", "COORDINADOR (A)", "DEFENSOR DEL USUARIO", "DIRECTOR", "DOCENTE", "EJECUTIVO", "EJECUTOR COACTIVO", "ESPECIALISTA", "GERENTE", "GESTOR", "INGENIERO", "JEFA", "JEFE", "JEFE DE OFICINA", "JEFE DE UNIDAD", "MANTENIMIENTO", "MECANICO", "MEDICO", "MONITOR LOCAL", "MONITOR REGIONAL", "OPERADOR", "PLANIFICADOR", "PRACTICANTE", "PROCURADOR/A PUBLICO/A", "PROFESIONAL", "PROFESIONAL ADMINISTRATIVO", "PROFESIONAL ESPECIALIZADO", "PROFESIONAL I", "PROGRAMADOR", "PSICOLOGO", "RECEPCIONISTA", "RESIDENTE DE OBRA", "RESPONSABLE", "SECRETARIA/O", "SOPORTE", "SOPORTE TECNICO", "SUPERVISOR", "TECNICO", "TECNICO/A ADMINISTRATIVO/A", "TRABAJADOR SOCIAL", "TUTOR", "OTRO/ESPECIFICAR", "CUENTA GENERICA", "BAJA", "BAJA OGRH"] }, compania: { name: 'Compañías/Sedes', items: ["SEDE CENTRAL", "SEDE EX-CENTROMIN", "SEDE MORELLI", "SEDE JAVIER PRADO", "SEDE GUARDIA CIVIL", "SEDE DIGEIE (CARABAYA)", "SEDE COMPOSTELA", "SEDE JR. TRUJILLO", "SEDE CNE", "SEDE CARLOS CUETO FERNANDINI", "SEDE JR. LORETO", "SEDE CENAREBE", "SEDE ALMACEN CENTRAL VENEZuela", "SEDE ALMACEN MAQUINARIAS", "SEDE CASA DE LA LITERATURA", "SEDE LA MOLINA", "COAR", "SEDE SENAJU", "SEDE FONDEP"] }, estado: { name: 'Estados', items: ["CREACIÓN", "ACTUALIZACIÓN", "DESHABILITACIÓN", "HABILITACIÓN"] }, tipo: { name: 'Tipos', items: ["1057 (CAS)", "GENERICA", "276", "728", "FAG", "PJTM", "PAC", "SERVIR"] } };
        async function seedInitialMaestras() { if (!maestrasCollectionRef) return; const snapshot = await getDocs(query(maestrasCollectionRef)); if (snapshot.docs.length === 0) { const batch = writeBatch(db); for (const key in initialMaestras) { batch.set(doc(maestrasCollectionRef, key), { name: initialMaestras[key].name, items: initialMaestras[key].items.sort() }); } await batch.commit(); } }
        function listenForMaestras() { if (unsubscribeMaestras) unsubscribeMaestras(); if (!maestrasCollectionRef) return; unsubscribeMaestras = onSnapshot(query(maestrasCollectionRef), (snapshot) => { allMaestras = {}; snapshot.docs.forEach(doc => allMaestras[doc.id] = doc.data()); populateAllDropdowns(); }); }
        function populateAllDropdowns() { for (const key in allMaestras) { const selectElement = document.getElementById(key); if (selectElement) populateDropdown(selectElement, allMaestras[key].items); } const sortedMaestras = Object.keys(allMaestras).map(key => ({ value: key, text: allMaestras[key].name })).sort((a,b) => a.text.localeCompare(b.text)); populateDropdown(maestraSelect, sortedMaestras); if (maestraSelect.value) displayMaestraItems(maestraSelect.value); }
        function populateDropdown(selectElement, options) { const currentValue = selectElement.value; selectElement.innerHTML = `<option value="">--SELECCIONAR--</option>`; options.forEach(option => { const optionEl = document.createElement('option'); if (typeof option === 'object') { optionEl.value = option.value; optionEl.textContent = option.text; } else { optionEl.value = option; optionEl.textContent = option; } selectElement.appendChild(optionEl); }); selectElement.value = currentValue; }
        function displayMaestraItems(maestraKey) { maestraItemsContainer.innerHTML = ''; if (!allMaestras[maestraKey] || !allMaestras[maestraKey].items) return; allMaestras[maestraKey].items.forEach(item => { const li = document.createElement('li'); li.className = 'flex justify-between items-center bg-white p-2 rounded-md shadow-sm'; const escapedItem = item.replace(/"/g, '&quot;').replace(/'/g, '&#39;'); li.innerHTML = `<span>${item}</span><button class="delete-item-btn text-red-500 hover:text-red-700 opacity-25 transition-opacity" data-item="${escapedItem}"><i class="fas fa-trash-alt"></i></button>`; maestraItemsContainer.appendChild(li); }); }
        async function updateMaestraInFirestore(maestraKey) { if (!maestrasCollectionRef || !allMaestras[maestraKey]) return; const docRef = doc(maestrasCollectionRef, maestraKey); try { await setDoc(docRef, allMaestras[maestraKey]); } catch (error) { console.error("Error al actualizar la maestra:", error); } }
        gestionMaestrasBtn.addEventListener('click', () => { if(maestraSelect.options.length > 1 && !maestraSelect.value) maestraSelect.selectedIndex = 1; displayMaestraItems(maestraSelect.value); openModal(maestrasModal); });
        closeMaestrasModalBtn.addEventListener('click', () => closeModal(maestrasModal));
        maestraSelect.addEventListener('change', () => displayMaestraItems(maestraSelect.value));
        newItemForm.addEventListener('submit', (e) => { e.preventDefault(); const selectedMaestra = maestraSelect.value, newItem = newItemInput.value.trim(); if (newItem && selectedMaestra && allMaestras[selectedMaestra] && !allMaestras[selectedMaestra].items.includes(newItem)) { allMaestras[selectedMaestra].items.push(newItem); allMaestras[selectedMaestra].items.sort(); updateMaestraInFirestore(selectedMaestra); newItemInput.value = ''; } else if (newItem) { alert('Este valor ya existe en la lista.'); } });
        maestraItemsContainer.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-item-btn'); if (deleteBtn) { const itemToDelete = deleteBtn.dataset.item, selectedMaestra = maestraSelect.value; if (itemToDelete && selectedMaestra && allMaestras[selectedMaestra]) { allMaestras[selectedMaestra].items = allMaestras[selectedMaestra].items.filter(item => item !== itemToDelete); updateMaestraInFirestore(selectedMaestra); } } });
        addNewMaestraBtn.addEventListener('click', () => openModal(newMaestraModal));
        closeNewMaestraModalBtn.addEventListener('click', () => closeModal(newMaestraModal));
        cancelNewMaestraBtn.addEventListener('click', () => closeModal(newMaestraModal));
        newMaestraForm.addEventListener('submit', async (e) => { e.preventDefault(); const newName = document.getElementById('newMaestraName').value.trim(); let newId = document.getElementById('newMaestraId').value.trim().toLowerCase().replace(/\s+/g, ''); if (!newName || !newId) { alert('Por favor, completa ambos campos.'); return; } if (allMaestras[newId]) { alert('El ID único ya existe. Por favor, elige otro.'); return; } try { await setDoc(doc(maestrasCollectionRef, newId), { name: newName, items: [] }); newMaestraForm.reset(); closeModal(newMaestraModal); } catch (error) { console.error("Error al crear la nueva maestra:", error); alert('Hubo un error al crear la lista.'); } });
        
        const openAccountModal = (isEdit = false, data = {}) => { accountForm.reset(); populateAllDropdowns(); setTimeout(() => { if (isEdit) { modalTitle.textContent = 'Editar Cuenta'; document.getElementById('accountId').value = data.id; Object.keys(data).forEach(key => { const el = document.getElementById(key); if (el) el.value = data[key] || ''; }); } else { modalTitle.textContent = 'Agregar Nueva Cuenta'; document.getElementById('accountId').value = ''; document.getElementById('fono').value = '0'; } openModal(accountModal); }, 100); };
        addAccountBtn.addEventListener('click', () => openAccountModal());
        closeModalBtn.addEventListener('click', () => closeModal(accountModal));
        cancelBtn.addEventListener('click', () => closeModal(accountModal));
        
        loadCsvBtn.addEventListener('click', () => csvInput.click());
        csvInput.addEventListener('change', handleFileUpload);
        
        function getPapa() { const P = (typeof window !== 'undefined' ? window.Papa : null) || (typeof Papa !== 'undefined' ? Papa : null); if (!P || typeof P.parse !== 'function') { const msg = 'Papa.parse no está disponible. Revisa el <script> de papaparse y su ORDEN de carga.'; console.error(msg, { Papa: P, windowPapa: window?.Papa }); throw new Error(msg); } return P; }
        function parseCsvFile(file) { const PapaSafe = getPapa(); return new Promise((resolve, reject) => { PapaSafe.parse(file, { header: true, skipEmptyLines: true, transformHeader: (h) => h.trim(), complete: (results) => resolve(results), error: (err) => reject(err), }); }); }
        async function procesarCsv(data, errors, meta) { if (errors && errors.length > 0) { console.error("Errores en el CSV:", errors); mostrarError(`Se encontraron errores en el archivo CSV. Por favor, revisa el formato. Error: ${errors[0].message}`); return; } const batch = writeBatch(db); data.forEach(row => { const oficina = row['OFI'] || '', departamento = oficinaDependenciaMap[oficina] || row['Departamento'] || ''; const accountData = { nombreMuestra: row['NombreMuestra'] || '', nombre: row['Nombre'] || '', apellido: row['Apellido'] || '', userPrin: row['UserPrin'] || '', sam: row['SAM'] || '', ofi: oficina, pass: row['PASS'] || '', desc: row['DESC'] || '', fono: row['Fono'] || '', titulo: row['Titulo'] || '', departamento: departamento, compania: row['Compania'] || '', proxy: row['proxy'] || '', samPropuesto: '', ticket: '', fecha: '', creador: '', estado: '', casResponsable: '', tipo: '', debaja90dias: '', licencia: '', observacion: '' }; batch.set(doc(accountsCollectionRef), accountData); }); try { await batch.commit(); uploadModalContent.innerHTML = `<i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i><h3 class="text-xl font-bold text-gray-800 mb-2">¡Carga Completa!</h3><p class="text-gray-600 mb-6">Se cargaron ${data.length} registros.</p><button id="closeUploadModalBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Cerrar</button>`; } catch (error) { console.error("Error al cargar datos en lote:", error); mostrarError("No se pudieron guardar los datos en la base de datos."); } uploadModal.querySelector('#closeUploadModalBtn').addEventListener('click', () => closeModal(uploadModal)); }
        async function handleFileUpload(ev) { const file = ev.target.files && ev.target.files[0]; if (!file) return; mostrarOverlay(true); try { const { data, errors, meta } = await parseCsvFile(file); await procesarCsv(data, errors, meta); } catch (e) { console.error('[CSV]', e); mostrarError(String(e?.message || e)); } finally { ev.target.value = ''; } }
        function mostrarOverlay(show) { if (show) { uploadModalContent.innerHTML = `<div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mx-auto mb-4"></div><h3 class="text-xl font-bold text-gray-800 mb-2">Procesando archivo...</h3><p class="text-gray-600">Por favor, espera.</p>`; openModal(uploadModal); } }
        function mostrarError(message) { console.error("Error al procesar CSV:", message); uploadModalContent.innerHTML = `<i class="fas fa-times-circle text-5xl text-red-500 mb-4"></i><h3 class="text-xl font-bold text-gray-800 mb-2">Error de Archivo</h3><p class="text-gray-600 mb-6">${message}</p><button id="closeUploadModalBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-blue-700">Cerrar</button>`; uploadModal.querySelector('#closeUploadModalBtn').addEventListener('click', () => closeModal(uploadModal)); }

        function exportSelectedToCsv() { const headers = ['NombreMuestra','Nombre','Apellido','UserPrin','SAM','OFI','PASS','DESC','Fono','Titulo','Departamento','Compania','Proxy'], dataKeys = ['nombreMuestra','nombre','apellido','userPrin','sam','ofi','pass','desc','fono','titulo','departamento','compania','proxy']; const selectedIds = [...document.querySelectorAll('.row-checkbox:checked')].map(cb => cb.dataset.id); if (selectedIds.length === 0) { alert("Por favor, selecciona al menos un registro para exportar."); return; } const dataToExport = allAccounts.filter(account => selectedIds.includes(account.id)).map(account => { return dataKeys.map(key => { const value = account[key] || '', stringValue = String(value); return (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) ? `"${stringValue.replace(/"/g, '""')}"` : stringValue; }).join(','); }); const csvContent = [headers.join(','), ...dataToExport].join('\n'), blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }), link = document.createElement("a"); if (link.download !== undefined) { const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", "exportacion_cuentas.csv"); link.style.visibility = 'hidden'; document.body.appendChild(link); link.click(); document.body.removeChild(link); } }
        exportCsvBtn.addEventListener('click', exportSelectedToCsv);
        function updateExportButtonState() { exportCsvBtn.disabled = document.querySelectorAll('.row-checkbox:checked').length === 0; }

        const renderAccounts = () => { if (!auth.currentUser) { accountsTableBody.innerHTML = `<tr><td colspan="25" class="text-center p-8 text-gray-500">Esperando autenticación...</td></tr>`; return; } const searchTerm = searchInput.value.toLowerCase(), filteredAccounts = allAccounts.filter(account => Object.values(account).some(val => String(val).toLowerCase().includes(searchTerm))); accountsTableBody.innerHTML = ''; if (filteredAccounts.length === 0) { accountsTableBody.innerHTML = `<tr><td colspan="25" class="text-center p-8 text-gray-500">No se encontraron registros.</td></tr>`; return; } filteredAccounts.forEach(account => { const tr = document.createElement('tr'); tr.className = 'border-b hover:bg-gray-50'; let actionsCell = `<td class="p-4 text-center"></td>`; if (currentUserRole === 'administrador' || currentUserRole === 'coordinador' || currentUserRole === 'especialista') { actionsCell = `<td class="p-4 text-center">`; if(currentUserRole === 'administrador' || currentUserRole === 'coordinador' || currentUserRole === 'especialista') { actionsCell += `<button class="edit-btn text-blue-500 hover:text-blue-700 mr-4" data-id="${account.id}"><i class="fas fa-pencil-alt"></i></button>`; } if(currentUserRole === 'administrador' || currentUserRole === 'coordinador') { actionsCell += `<button class="delete-btn text-red-500 hover:text-red-700" data-id="${account.id}"><i class="fas fa-trash-alt"></i></button>`; } actionsCell += `</td>`; } tr.innerHTML = `<td class="p-4 text-center"><input type="checkbox" class="row-checkbox h-5 w-5 rounded" data-id="${account.id}"></td><td class="p-4 whitespace-nowrap">${account.nombreMuestra||''}</td><td class="p-4 whitespace-nowrap">${account.nombre||''}</td><td class="p-4 whitespace-nowrap">${account.apellido||''}</td><td class="p-4 whitespace-nowrap">${account.userPrin||''}</td><td class="p-4 whitespace-nowrap">${account.sam||''}</td><td class="p-4 whitespace-nowrap">${account.samPropuesto||''}</td><td class="p-4 whitespace-nowrap">${account.ofi||''}</td><td class="p-4 whitespace-nowrap">${account.pass||''}</td><td class="p-4 whitespace-nowrap">${account.desc||''}</td><td class="p-4 whitespace-nowrap">${account.fono||''}</td><td class="p-4 whitespace-nowrap">${account.titulo||''}</td><td class="p-4 whitespace-nowrap">${account.departamento||''}</td><td class="p-4 whitespace-nowrap">${account.compania||''}</td><td class="p-4 whitespace-nowrap">${account.proxy||''}</td><td class="p-4 whitespace-nowrap">${account.ticket||''}</td><td class="p-4 whitespace-nowrap">${account.fecha||''}</td><td class="p-4 whitespace-nowrap">${account.creador||''}</td><td class="p-4 whitespace-nowrap"><span class="px-3 py-1 text-xs font-medium rounded-full ${getSatusClass(account.estado)}">${account.estado||''}</span></td><td class="p-4 whitespace-nowrap">${account.casResponsable||''}</td><td class="p-4 whitespace-nowrap">${account.tipo||''}</td><td class="p-4 whitespace-nowrap">${account.debaja90dias||''}</td><td class="p-4 whitespace-nowrap">${account.licencia||''}</td><td class="p-4 whitespace-nowrap">${account.observacion||''}</td>${actionsCell}`; accountsTableBody.appendChild(tr); }); updateExportButtonState(); };
        const getSatusClass = (status) => { switch(status) { case 'CREACIÓN': return 'bg-green-100 text-green-800'; case 'ACTUALIZACIÓN': return 'bg-yellow-100 text-yellow-800'; case 'DESHABILITACIÓN': return 'bg-red-100 text-red-800'; case 'HABILITACIÓN': return 'bg-blue-100 text-blue-800'; default: return 'bg-gray-100 text-gray-800'; } };
        const listenForAccounts = () => { if (unsubscribeAccounts) unsubscribeAccounts(); if (!accountsCollectionRef) return; unsubscribeAccounts = onSnapshot(query(accountsCollectionRef), (snapshot) => { allAccounts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); allAccounts.sort((a, b) => (b.fecha || '').localeCompare(a.fecha || '')); renderAccounts(); }, (error) => { console.error("Error al obtener datos:", error); accountsTableBody.innerHTML = `<tr><td colspan="25" class="text-center p-8 text-red-500">Error al cargar los datos. Revisa las reglas de seguridad.</td></tr>`; }); };
        searchInput.addEventListener('input', renderAccounts);

        accountForm.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth.currentUser) return; const id = document.getElementById('accountId').value; const accountData = { nombreMuestra: document.getElementById('nombreMuestra').value, nombre: document.getElementById('nombre').value, apellido: document.getElementById('apellido').value, userPrin: document.getElementById('userPrin').value, sam: document.getElementById('sam').value, samPropuesto: document.getElementById('samPropuesto').value, ofi: document.getElementById('ofi').value, departamento: document.getElementById('departamento').value, pass: document.getElementById('pass').value, desc: document.getElementById('desc').value, fono: document.getElementById('fono').value, titulo: document.getElementById('titulo').value, compania: document.getElementById('compania').value, proxy: document.getElementById('proxy').value, ticket: document.getElementById('ticket').value, fecha: document.getElementById('fecha').value, estado: document.getElementById('estado').value, casResponsable: document.getElementById('casResponsable').value, tipo: document.getElementById('tipo').value, debaja90dias: document.getElementById('debaja90dias').value, licencia: document.getElementById('licencia').value, observacion: document.getElementById('observacion').value }; accountData.creador = `${auth.currentUser.email} (${currentUserRole.charAt(0).toUpperCase() + currentUserRole.slice(1)})`; try { if (id) { const oldDoc = await getDoc(doc(accountsCollectionRef, id)); await setDoc(doc(accountsCollectionRef, id), accountData); await logAuditEvent('Actualización', accountData.nombreMuestra, getChanges(oldDoc.data(), accountData), accountData.sam, accountData.desc); } else { await addDoc(accountsCollectionRef, accountData); await logAuditEvent('Creación', accountData.nombreMuestra, 'Nueva cuenta creada.', accountData.sam, accountData.desc); } closeModal(accountModal); } catch (error) { console.error("Error al guardar el documento: ", error); } });
        
        const openGenericDeleteModal = (text, callback) => {
            deleteModalText.textContent = text;
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            
            const confirmHandler = async () => {
                await callback();
                closeModal(deleteModal);
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                closeModal(deleteModal);
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler);
            cancelBtn.addEventListener('click', cancelHandler);

            openModal(deleteModal);
        };
        
        accountsTableBody.addEventListener('click', async (e) => { 
            const target = e.target; 
            if (!auth.currentUser) return; 
            if (target.classList.contains('row-checkbox')) { 
                updateExportButtonState(); return; 
            } 
            const button = target.closest('button'); 
            if (!button) return; 
            const id = button.dataset.id; 
            if (button.classList.contains('edit-btn')) { 
                try { 
                    const docSnap = await getDoc(doc(accountsCollectionRef, id)); 
                    if (docSnap.exists()) openAccountModal(true, { id: docSnap.id, ...docSnap.data() }); 
                } catch (error) { console.error("Error al obtener documento para editar:", error); } 
            } else if (button.classList.contains('delete-btn')) {
                const accountToDelete = allAccounts.find(acc => acc.id === id);
                openGenericDeleteModal(
                    `Se eliminará la cuenta '${accountToDelete?.nombreMuestra || 'seleccionada'}' permanentemente. ¿Continuar?`,
                    async () => {
                        try {
                            const docRef = doc(accountsCollectionRef, id);
                            const docSnap = await getDoc(docRef);
                            if(docSnap.exists()){
                                const data = docSnap.data();
                                await logAuditEvent('Eliminación', data.nombreMuestra, `Se eliminó la cuenta con todos sus datos.`, data.sam, data.desc);
                                await deleteDoc(docRef);
                            }
                        } catch(error) {
                            console.error("Error al eliminar el documento:", error);
                            alert("No se pudo eliminar el registro.");
                        }
                    }
                );
            } 
        });

        document.getElementById('selectAllCheckbox').addEventListener('change', (e) => { document.querySelectorAll('.row-checkbox').forEach(checkbox => checkbox.checked = e.target.checked); updateExportButtonState(); });
        
        function listenForUsers() { if (unsubscribeUsers) unsubscribeUsers(); if (!usersCollectionRef) return; unsubscribeUsers = onSnapshot(query(usersCollectionRef), snapshot => { allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderUserList(); }); }
        function renderUserList() {
            userListContainer.innerHTML = '';
            
            if (allUsers.length === 0) {
                userListContainer.innerHTML = '<li><p class="text-center text-gray-500">No hay usuarios registrados en la base de datos de roles.</p></li>';
                return;
            }

            allUsers.forEach(user => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                const isCurrentUserAdmin = user.email === 'mcueva@minedu.gob.pe';
                
                li.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${user.email}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <select class="role-select p-2 border rounded-lg bg-white" data-userid="${user.id}" ${isCurrentUserAdmin ? 'disabled' : ''}>
                            <option value="administrador" ${user.role === 'administrador' ? 'selected' : ''}>Administrador</option>
                            <option value="coordinador" ${user.role === 'coordinador' ? 'selected' : ''}>Coordinador</option>
                            <option value="especialista" ${user.role === 'especialista' ? 'selected' : ''}>Especialista</option>
                            <option value="visitante" ${user.role === 'visitante' ? 'selected' : ''}>Visitante</option>
                        </select>
                        ${!isCurrentUserAdmin ? `<button class="delete-user-btn bg-red-500 text-white px-3 py-1 rounded-md text-xs hover:bg-red-600" data-userid="${user.id}">Eliminar</button>` : ''}
                    </div>`;
                userListContainer.appendChild(li);
            });
        }
        manageUsersBtn.addEventListener('click', () => openModal(userManagementModal));
        closeUserManagementModalBtn.addEventListener('click', () => closeModal(userManagementModal));
        
        addUserToSystemForm.addEventListener('submit', async e => { 
            e.preventDefault(); 
            const email = document.getElementById('newUserEmail').value;
            const uid = document.getElementById('newUserId').value;
            const role = document.getElementById('newUserRole').value; 
            
            if (!email || !role || !uid) {
                alert("Por favor, complete todos los campos: Correo, UID y Rol.");
                return;
            }
            
            try { 
                const userDocRef = doc(db, "users", uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                     alert("Este usuario (por su UID) ya está registrado en el sistema de roles.");
                     return;
                }
                
                const q = query(collection(db, "users"), where("email", "==", email));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                     alert("Ya existe un rol asignado para este correo electrónico.");
                     return;
                }
                
                await setDoc(userDocRef, { email, role });
                addUserToSystemForm.reset(); 
            } catch (error) { 
                console.error("Error adding user to system:", error); 
                alert("No se pudo agregar el usuario. Verifica los permisos y que el UID sea correcto."); 
            } 
        });

        userListContainer.addEventListener('change', async e => { if (e.target.classList.contains('role-select')) { const userId = e.target.dataset.userid, newRole = e.target.value; try { await setDoc(doc(usersCollectionRef, userId), { role: newRole }, { merge: true }); } catch (error) { console.error("Error updating role:", error); alert("No se pudo actualizar el rol."); } } });
        userListContainer.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-user-btn'); 
            if (deleteBtn) {
                const userId = deleteBtn.dataset.userid;
                const userToDelete = allUsers.find(u => u.id === userId);
                openGenericDeleteModal(
                    `Se eliminará el rol para el usuario '${userToDelete?.email || 'seleccionado'}'. El usuario ya no tendrá acceso con rol al sistema. ¿Continuar?`,
                    async () => {
                        try {
                            await deleteDoc(doc(usersCollectionRef, userId));
                        } catch (error) {
                            console.error("Error deleting user role:", error);
                            alert("No se pudo eliminar el rol del usuario.");
                        }
                    }
                );
            }
        });

        changePasswordBtn.addEventListener('click', () => { passwordChangeStatus.textContent = ''; changePasswordForm.reset(); openModal(changePasswordModal); });
        closeChangePasswordModalBtn.addEventListener('click', () => closeModal(changePasswordModal));
        cancelChangePasswordBtn.addEventListener('click', () => closeModal(changePasswordModal));
        changePasswordForm.addEventListener('submit', async e => { e.preventDefault(); const newPass = document.getElementById('newPassword').value, confirmPass = document.getElementById('confirmPassword').value; if (newPass.length < 6) { passwordChangeStatus.textContent = 'La contraseña debe tener al menos 6 caracteres.'; passwordChangeStatus.className = 'text-sm text-center text-red-600'; return; } if (newPass !== confirmPass) { passwordChangeStatus.textContent = 'Las contraseñas no coinciden.'; passwordChangeStatus.className = 'text-sm text-center text-red-600'; return; } const user = auth.currentUser; if (user) { try { await updatePassword(user, newPass); passwordChangeStatus.textContent = 'Contraseña actualizada con éxito.'; passwordChangeStatus.className = 'text-sm text-center text-green-600'; setTimeout(() => closeModal(changePasswordModal), 2000); } catch (error) { console.error("Password update failed:", error); passwordChangeStatus.textContent = 'Error al actualizar. Intenta cerrar sesión y volver a ingresar.'; passwordChangeStatus.className = 'text-sm text-center text-red-600'; } } });
        
        // --- AUDIT LOG ---
        async function logAuditEvent(action, targetAccount, details, sam = '', dni = '') { if (!auditCollectionRef) return; try { await addDoc(auditCollectionRef, { userEmail: auth.currentUser.email, action, targetAccount, details, sam, dni, timestamp: serverTimestamp() }); } catch (error) { console.error('Error writing audit log:', error); } }
        function getChanges(oldData, newData) { const changes = []; for (const key in newData) { if (oldData[key] !== newData[key]) { changes.push(`'${key}': de '${oldData[key] || ""}' a '${newData[key] || ""}'`); } } return changes.join(', ') || 'No se detectaron cambios.'; }
        function listenForAuditLog() { if (unsubscribeAudit) unsubscribeAudit(); if (!auditCollectionRef) return; const q = query(auditCollectionRef, orderBy('timestamp', 'desc'), limit(500)); unsubscribeAudit = onSnapshot(q, snapshot => { allAuditLogs = snapshot.docs.map(d => ({ id: d.id, ...d.data() })); renderAuditLog(); }, (error) => { console.error("Audit log listener error:", error); auditLogTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-red-500">Error al cargar la auditoría. Revisa los permisos.</td></tr>'; }); }
        function renderAuditLog() {
            const searchTerm = auditSearchInput.value.toLowerCase();
            const filteredLogs = allAuditLogs.filter(log => Object.values({ ...log, timestamp: log.timestamp ? new Date(log.timestamp.seconds*1000).toISOString() : '' }).some(v => String(v).toLowerCase().includes(searchTerm)) );
            
            auditLogTableBody.innerHTML = '';
            if (filteredLogs.length === 0) { auditLogTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-4">Sin resultados (o cargando)...</td></tr>'; return; }
            filteredLogs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                const date = log.timestamp?.seconds ? new Date(log.timestamp.seconds * 1000).toLocaleString('es-PE') : 'Pendiente...';
                tr.innerHTML = `<td class="p-3">${date}</td><td class="p-3">${log.userEmail||''}</td><td class="p-3">${log.action||''}</td><td class="p-3">${log.targetAccount||''}</td><td class="p-3">${log.sam||''}</td><td class="p-3">${log.dni||''}</td><td class="p-3">${log.details||''}</td>`;
                auditLogTableBody.appendChild(tr);
            });
        }
        auditLogBtn.addEventListener('click', () => { if (!unsubscribeAudit && currentUserRole === 'administrador') listenForAuditLog(); openModal(auditLogModal); });
        closeAuditLogModalBtn.addEventListener('click', () => closeModal(auditLogModal));
        auditSearchInput.addEventListener('input', renderAuditLog);
    </script>
</body>
</html>

